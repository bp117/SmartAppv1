<!DOCTYPE html>
<html>
<head>
  <title>Wells Fargo Branch Recommendations</title>
  <style>
    #map {
      height: 100%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=pp&&libraries=places&callback=initMap" async defer></script>
</head>
<body>
  <div id="map"></div>
  <script>
    let map;
    const charlotteLocation = { lat: 35.2271, lng: -80.8431 }; // Charlotte, NC
    let placesService;
    let distanceMatrixService;
    let currentLocationMarker;
    const markers = [];
    let openInfoWindow; // Reference to the currently open info window

    const CUSTOM_WELLSFARGO_ICON_URL = 'wf.png'; // Replace with the URL of your custom icon

    function initMap() {
      // Create a map centered at Charlotte, NC
      map = new google.maps.Map(document.getElementById('map'), {
        center: charlotteLocation,
        zoom: 12
      });

      // Add traffic layer
      const trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      // Initialize Places and Distance Matrix services
      placesService = new google.maps.places.PlacesService(map);
      distanceMatrixService = new google.maps.DistanceMatrixService();

      // Indicate the Charlotte location as current location
      currentLocationMarker = new google.maps.Marker({
        position: charlotteLocation,
        map: map,
        title: 'Charlotte, NC',
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
          scaledSize: new google.maps.Size(40, 40)
        }
      });

      // Search for Wells Fargo branches near Charlotte, NC
      searchWellsFargoBranches();
    }

    function searchWellsFargoBranches() {
      const request = {
        location: charlotteLocation,
        radius: '10000', // 10km radius
        type: ['bank'],
        keyword: 'Wells Fargo'
      };

      placesService.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          calculateDistances(results);
        }
      });
    }

    function calculateDistances(branches) {
      const destinations = branches.map(branch => branch.geometry.location);
      distanceMatrixService.getDistanceMatrix({
        origins: [new google.maps.LatLng(charlotteLocation.lat, charlotteLocation.lng)],
        destinations: destinations,
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.IMPERIAL, // Use Imperial units for miles
      }, (response, status) => {
        if (status === google.maps.DistanceMatrixStatus.OK) {
          const results = response.rows[0].elements;
          const distances = results.map((result, index) => ({
            branch: branches[index],
            duration: result.duration.value, // Duration in seconds
            distance: result.distance.value, // Distance in meters
            distanceText: result.distance.text, // Distance text
            waitTime: Math.floor(Math.random() * 30) + 1 // Random wait time between 1 and 30 minutes
          }));
          distances.sort((a, b) => a.duration - b.duration);
          const topBranches = distances.slice(0, 3);
          displayBranches(topBranches);
          setTimeout(setMapZoomAndCenter, 100); // Delay to ensure markers are added before fitting bounds
        }
      });
    }

    function displayBranches(topBranches) {
      topBranches.forEach(item => {
        const marker = new google.maps.Marker({
          position: item.branch.geometry.location,
          map: map,
          title: item.branch.name,
          icon: {
            url: CUSTOM_WELLSFARGO_ICON_URL, // Use the custom Wells Fargo icon
            scaledSize: new google.maps.Size(50, 50) // Increase size
          }
        });

        markers.push(marker);

        const contentString = `<div class="info-window-content">
                                <strong>${item.branch.name}</strong><br>
                                ${item.branch.vicinity}<br>
                                Distance: ${item.distanceText}<br>
                                Travel Time: ${(item.duration / 60).toFixed(2)} mins<br>
                                Wait Time: ${item.waitTime} mins
                              </div>`;

        const infowindow = new google.maps.InfoWindow({
          content: contentString
        });

        // Automatically open all info windows
        infowindow.open(map, marker);

        google.maps.event.addListener(infowindow, 'domready', () => {
          document.querySelector('.info-window-content').addEventListener('click', () => {
            // Notify the native app about the branch click event
            if (window.nativeapp && window.nativeapp.bridge && window.nativeapp.bridge.execute) {
              window.nativeapp.bridge.execute('goNativeScreen', {
                screenName: 'googlemaps',
                currentCoordinates: {
                  lat: charlotteLocation.lat,
                  lng: charlotteLocation.lng
                },
                branchCoordinates: {
                  lat: item.branch.geometry.location.lat(),
                  lng: item.branch.geometry.location.lng()
                },
                branchDetails: {
                  name: item.branch.name,
                  vicinity: item.branch.vicinity,
                  distance: item.distanceText,
                  duration: (item.duration / 60).toFixed(2),
                  waitTime: item.waitTime
                }
              });
            }
          });
        });

        marker.addListener('click', () => {
          if (openInfoWindow) {
            openInfoWindow.close();
          }
          infowindow.open(map, marker);
          openInfoWindow = infowindow;
        });
      });
    }

    function setMapZoomAndCenter() {
      const bounds = new google.maps.LatLngBounds();
      markers.forEach(marker => {
        bounds.extend(marker.getPosition());
      });
      bounds.extend(charlotteLocation);
      map.fitBounds(bounds);
    }
  </script>
</body>
</html>
